<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Parcelas Interactivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    #sidebar {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 360px;
      max-height: 95vh;
      overflow-y: auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10;
    }
    #sidebar h2 {
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 600;
    }
    label {
      margin-top: 10px;
      display: block;
      font-weight: 600;
      font-size: 13px;
      color: #333;
    }
    input, select, textarea, button {
      width: 100%;
      margin-top: 6px;
      margin-bottom: 12px;
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    input[type="color"] {
      height: 40px;
      padding: 0;
      border: none;
      cursor: pointer;
      background-color: transparent;
    }
    button {
      background-color: #0066cc;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #004da3;
    }
    ul#searchResults {
      list-style: none;
      padding: 0;
      margin: 0 0 10px;
    }
    ul#searchResults li {
      padding: 8px;
      background: #f8f8f8;
      border-radius: 4px;
      margin-bottom: 6px;
      border-left: 4px solid #0066cc;
      cursor: pointer;
    }
    ul#searchResults li:hover {
      background-color: #e6f0ff;
    }
    #parcelDetails {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      font-size: 13px;
    }
    #parcelDetails table {
      width: 100%;
      border-collapse: collapse;
    }
    #parcelDetails td {
      padding: 4px 6px;
      border-bottom: 1px solid #ddd;
    }
    #parcelDetails td:first-child {
      font-weight: 600;
      color: #555;
      width: 40%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h2>Gestor de Parcelas</h2>
    <label for="searchInput">Buscar por Catastro:</label>
    <input type="text" id="searchInput" placeholder="Ej: 252" />
    <button id="searchBtn">Buscar</button>
    <ul id="searchResults"></ul>

    <label for="mapStyle">Estilo de Mapa:</label>
    <select id="mapStyle">
      <option value="mapbox://styles/mapbox/streets-v11">Seleccione un Estilo</option>
      <option value="mapbox://styles/mapbox/streets-v11">Calles</option>
      <option value="mapbox://styles/mapbox/satellite-v9">Satélite</option>
      <option value="mapbox://styles/mapbox/satellite-streets-v12">Satélite + Calles</option>
      <option value="mapbox://styles/mapbox/light-v11">Claro</option>
      <option value="mapbox://styles/mapbox/dark-v11">Oscuro</option>
      <option value="mapbox://styles/mapbox/outdoors-v11">Exteriores</option>
      <option value="mapbox://styles/mapbox/navigation-day-v1">Navegación Día</option>
      <option value="mapbox://styles/mapbox/navigation-night-v1">Navegación Noche</option>
    </select>

    <label>Parcela seleccionada:</label>
    <div><strong>ID:</strong> <span id="parcelId">Ninguna</span></div>
    <div id="parcelDetails"></div>

    <label for="colorInput">Color:</label>
    <input type="color" id="colorInput" value="#ff0000" />

    <label for="obsInput">Observaciones:</label>
    <textarea id="obsInput" rows="3" placeholder="Escriba aquí..."></textarea>

    <label for="supInput">Superficie:</label>
    <input type="text" id="supInput" placeholder="Ej: 280 m²" />

    <label for="consInput">Construido:</label>
    <input type="text" id="consInput" placeholder="Ej: 140 m²" />

    <label for="valorInput">Valor estimado:</label>
    <input type="text" id="valorInput" placeholder="Ej: $8.500.000" />

    <button id="saveBtn">Guardar cambios</button>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCoxbm_jXwcC3bRHC7uYcqKmKO-BA7zBy0",
      authDomain: "mapasaltaparcelas-dfeb0.firebaseapp.com",
      projectId: "mapasaltaparcelas-dfeb0",
      storageBucket: "mapasaltaparcelas-dfeb0.appspot.com",
      messagingSenderId: "783736714984",
      appId: "1:783736714984:web:5839f8049f515cba3d7b5d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    mapboxgl.accessToken = 'pk.eyJ1Ijoib2N0YXZpb2dhbHZhbjUiLCJhIjoiY21iZjQ2bG1xMm93MjJxb2tidm84Zzh4cSJ9.-3ZpHXCEbwsf1Gc3NSkibQ';

    const parcelColors = {};
    const parcelObservations = {};
    const parcelExtras = {};
    let map;

    function renderDetails(properties) {
      return `<table>${
        Object.entries(properties)
          .map(([key, val]) => `<tr><td>${key}</td><td>${val ?? '-'}</td></tr>`)
          .join('')
      }</table>`;
    }

    function updateParcelColors() {
      if (!map.getLayer('parcelas-layer')) return;
      const expression = ['match', ['get', 'VINCULACIO']];
      for (const [id, color] of Object.entries(parcelColors)) {
        expression.push(id, color);
      }
      expression.push('#00aaff');
      map.setPaintProperty('parcelas-layer', 'fill-color', expression);
    }

    async function loadFromFirestore() {
      const snapshot = await db.collection('parcelas').get();
      snapshot.forEach(doc => {
        const data = doc.data();
        const id = doc.id;
        parcelColors[id] = data.color || '#00aaff';
        parcelObservations[id] = data.observacion || '';
        parcelExtras[id] = {
          superficie: data.superficie || '',
          construido: data.construido || '',
          valor: data.valor || ''
        };
      });
    }

    async function saveToFirestore(id, color, observacion, superficie, construido, valor) {
      await db.collection('parcelas').doc(id).set({
        color,
        observacion,
        superficie,
        construido,
        valor
      });
    }

    async function initMap(styleURL) {
      const center = map ? map.getCenter() : [-65.4, -24.8];
      const zoom = map ? map.getZoom() : 13;

      if (map) map.remove();

      map = new mapboxgl.Map({
        container: 'map',
        style: styleURL,
        center: center,
        zoom: zoom
      });

      await loadFromFirestore();

      map.on('load', () => {
        map.addSource('parcelas', {
          type: 'vector',
          url: 'mapbox://octaviogalvan5.86x2clxn'
        });

        map.addLayer({
          id: 'parcelas-layer',
          type: 'fill',
          source: 'parcelas',
          'source-layer': 'archivo-2xi9qg',
          paint: {
            'fill-color': ['match', ['get', 'VINCULACIO'], '', '#ff0000', '#ff0000'],
            'fill-opacity': 0.3
          }
        });

        map.addLayer({
          id: 'selected-parcela',
          type: 'line',
          source: 'parcelas',
          'source-layer': 'archivo-2xi9qg',
          paint: {
            'line-color': '#00aaff',
            'line-width': 3
          },
          filter: ['==', 'VINCULACIO', '']
        });

        updateParcelColors();

        map.on('click', 'parcelas-layer', (e) => {
          const feature = e.features[0];
          const id = feature.properties.VINCULACIO;

          document.getElementById('parcelId').textContent = id;
          document.getElementById('obsInput').value = parcelObservations[id] || '';
          document.getElementById('colorInput').value = parcelColors[id] || '#ff0000';
          document.getElementById('supInput').value = parcelExtras[id]?.superficie || '';
          document.getElementById('consInput').value = parcelExtras[id]?.construido || '';
          document.getElementById('valorInput').value = parcelExtras[id]?.valor || '';
          document.getElementById('parcelDetails').innerHTML = renderDetails(feature.properties);
          document.getElementById('saveBtn').dataset.currentId = id;

          map.setFilter('selected-parcela', ['==', 'VINCULACIO', id]);
        });

        map.on('mouseenter', 'parcelas-layer', () => {
          map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'parcelas-layer', () => {
          map.getCanvas().style.cursor = '';
        });
      });
    }

    initMap('mapbox://styles/mapbox/streets-v11');

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const id = document.getElementById('saveBtn').dataset.currentId;
      if (!id) return;

      const color = document.getElementById('colorInput').value;
      const observacion = document.getElementById('obsInput').value;
      const superficie = document.getElementById('supInput').value;
      const construido = document.getElementById('consInput').value;
      const valor = document.getElementById('valorInput').value;

      parcelColors[id] = color;
      parcelObservations[id] = observacion;
      parcelExtras[id] = { superficie, construido, valor };

      updateParcelColors();
      await saveToFirestore(id, color, observacion, superficie, construido, valor);
    });

    document.getElementById('mapStyle').addEventListener('change', (e) => {
      const newStyle = e.target.value;
      initMap(newStyle);
    });

    document.getElementById('searchBtn').addEventListener('click', async () => {
      const value = document.getElementById('searchInput').value.trim();
      const resultsList = document.getElementById('searchResults');
      resultsList.innerHTML = '';

      if (!value) return;

      const features = map.querySourceFeatures('parcelas', {
        sourceLayer: 'archivo-2xi9qg'
      });

      const results = features.filter(f =>
        String(f.properties.CATASTRO).includes(value)
      );

      if (results.length === 0) {
        resultsList.innerHTML = '<li>No se encontraron resultados.</li>';
        return;
      }

      results.forEach(feature => {
        const id = feature.properties.VINCULACIO;
        const departamento = feature.properties.DEPARTA || '—';
        const localidad = feature.properties.LOCALID || '—';
        const catastro = feature.properties.CATASTRO;

        const li = document.createElement('li');
        li.textContent = `Catastro: ${catastro} - Dpto: ${departamento} - Loc: ${localidad}`;
        li.onclick = () => {
          const center = turf.center(feature).geometry.coordinates;
          map.flyTo({ center: center, zoom: 17 });
          map.fire('click', { point: map.project(center) });
          map.setFilter('selected-parcela', ['==', 'VINCULACIO', id]);
        };
        resultsList.appendChild(li);
      });
    });
  </script>
</body>
</html>
